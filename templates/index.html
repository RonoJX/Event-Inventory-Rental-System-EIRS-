<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Pro - Panel de Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        #calendar { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .fc-event { cursor: pointer; border: none !important; padding: 2px 5px; }
        .fc-toolbar-title { font-size: 1.2rem !important; font-weight: bold; text-transform: capitalize; }
        .vista-detalle { display: none; margin-top: 2rem; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background-color: #2c3e50; border-bottom: 2px solid #7d5fff;">
        <div class="container d-flex justify-content-between align-items-center" style="height: 60px;">
            <a class="navbar-brand fw-bold" href="/">Event Club</a>
            <div class="d-flex">
                <a href="/" class="btn btn-sm btn-primary me-2">Admin</a>
                <a href="/vendedor" class="btn btn-sm btn-outline-light me-2">Ventas</a>
                <a href="/empleado" class="btn btn-sm btn-outline-light">Campo</a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row g-4 mb-5">
            {% for item in resumen %}
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100" style="border-radius: 12px; background: white;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="text-uppercase fw-bold text-secondary m-0" style="font-size: 0.9rem;">{{ item.nombre }}</h5>
                            <button class="btn btn-sm btn-light text-muted" onclick="abrirModalStock('{{ item.id }}', '{{ item.nombre }}')">锔</button>
                        </div>
                        <div class="display-6 fw-bold text-primary">{{ item.en_bodega }}</div>
                        <p class="mb-0 fw-bold">En Bodega</p>
                        <small class="text-muted">Total Propiedad: {{ item.total_global }}</small>
                        <hr>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-danger btn-sm py-2" onclick="cargarDetalles('{{ item.id }}', 'danadas', '{{ item.nombre }}')">
                                Da帽adas: <strong>{{ item.danadas }}</strong>
                            </button>
                            <button class="btn btn-outline-success btn-sm py-2" onclick="cargarDetalles('{{ item.id }}', 'alquiler', '{{ item.nombre }}')">
                                Alquiladas: <strong>{{ item.alquiladas }}</strong>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div id="vista-danadas" class="vista-detalle mb-5">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center py-3">
                    <h6 class="m-0 fw-bold">锔 Reportes de Da帽os: <span id="nom-cat-d"></span></h6>
                    <button class="btn-close btn-close-white" onclick="cerrar()"></button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr><th class="ps-4">Descripci贸n del Incidente</th><th class="text-end pe-4">Fecha Reporte</th></tr>
                        </thead>
                        <tbody id="body-danos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="vista-alquiler" class="vista-detalle mb-5">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center py-3">
                    <h6 class="m-0 fw-bold"> Alquileres Activos: <span id="nom-cat-a"></span></h6>
                    <button class="btn-close btn-close-white" onclick="cerrar()"></button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr><th class="ps-4">Cliente</th><th>Ubicaci贸n</th><th>Entrega</th><th class="text-end pe-4">Estado</th></tr>
                        </thead>
                        <tbody id="body-alquiler"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm p-4" style="border-radius: 15px;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold m-0 text-primary"> Agenda y Control de Alquileres</h4>
                        <span class="badge bg-light text-muted border">Clic en un d铆a para reporte diario</span>
                    </div>
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalStock" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <form action="/api/agregar_stock" method="POST" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">A帽adir Unidades: <span id="modal-nom"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="modal-id">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Cantidad a sumar al inventario global:</label>
                        <input type="number" name="cantidad" class="form-control" placeholder="Ej: 10" required min="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">ACTUALIZAR STOCK</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="modalDetalleCal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title fw-bold">Informaci贸n del Alquiler</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h4 class="fw-bold text-primary mb-1" id="cal-cliente"></h4>
                    <p class="text-muted border-bottom pb-2" id="cal-articulo"></p>
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="small text-uppercase fw-bold text-success"> Entrega</label>
                            <div id="cal-entrega" class="fw-bold"></div>
                        </div>
                        <div class="col-6">
                            <label class="small text-uppercase fw-bold text-danger"> Recogida</label>
                            <div id="cal-retiro" class="fw-bold"></div>
                        </div>
                        <div class="col-12">
                            <label class="small text-uppercase fw-bold text-muted"> Ubicaci贸n</label>
                            <div id="cal-ubi" class="p-2 bg-light rounded mt-1"></div>
                        </div>
                        <div class="col-12">
                            <label class="small text-uppercase fw-bold text-muted"> Estado</label>
                            <div id="cal-estado" class="mt-1"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger w-100 fw-bold" onclick="descargarPDFIndividual()"> DESCARGAR PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <script>
        let calendar;

        // --- 1. L贸gica del Calendario ---
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var modalDetalle = new bootstrap.Modal(document.getElementById('modalDetalleCal'));

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
                events: '/api/eventos_calendario',
                eventClick: function(info) {
                    const p = info.event.extendedProps;
                    document.getElementById('cal-cliente').innerText = p.cliente;
                    document.getElementById('cal-articulo').innerText = p.articulo;
                    document.getElementById('cal-entrega').innerText = p.entrega;
                    document.getElementById('cal-retiro').innerText = p.retiro;
                    document.getElementById('cal-ubi').innerText = p.ubicacion;
                    document.getElementById('cal-estado').innerHTML = `<span class="badge bg-primary fs-6">${p.estado}</span>`;
                    modalDetalle.show();
                },
                dateClick: function(info) {
                    const eventsOnDate = calendar.getEvents().filter(e => e.startStr.split('T')[0] === info.dateStr);
                    if (eventsOnDate.length > 0) {
                        if(confirm(`Reporte del d铆a ${info.dateStr}: Se encontraron ${eventsOnDate.length} registros. 驴Descargar?`)) {
                            descargarReporteDiario(info.dateStr, eventsOnDate);
                        }
                    } else { alert("No hay pedidos hoy."); }
                }
            });
            calendar.render();
        });

        // --- 2. CARGAR DETALLES DE DAOS O ALQUILER (Aqu铆 estaba tu error) ---
        async function cargarDetalles(id, tipo, nombre) {
            cerrar(); // Ocultar tablas anteriores
            const res = await fetch(`/api/detalles/${id}/${tipo}`);
            const datos = await res.json();

            if (tipo === 'danadas') {
                const b = document.getElementById('body-danos');
                document.getElementById('nom-cat-d').innerText = nombre;
                b.innerHTML = datos.length ? '' : '<tr><td colspan="2" class="text-center p-3">Sin reportes</td></tr>';
                datos.forEach(d => {
                    b.innerHTML += `<tr><td class="ps-4 py-3"><b>锔 Da帽o:</b> ${d.descripcion || 'Sin descripci贸n'}</td><td class="text-end pe-4 text-muted small">${d.fecha_dano}</td></tr>`;
                });
                document.getElementById('vista-danadas').style.display = 'block';
            } else {
                const b = document.getElementById('body-alquiler');
                document.getElementById('nom-cat-a').innerText = nombre;
                b.innerHTML = datos.length ? '' : '<tr><td colspan="4" class="text-center p-3">Sin alquileres</td></tr>';
                datos.forEach(a => {
                    b.innerHTML += `<tr><td class="ps-4 py-3 fw-bold">${a.cliente}</td><td>${a.ubicacion}</td><td>${a.tiempo}</td><td class="text-end pe-4"><span class="badge bg-info">${a.estado}</span></td></tr>`;
                });
                document.getElementById('vista-alquiler').style.display = 'block';
            }
            window.scrollTo({ top: 100, behavior: 'smooth' }); // Subir un poco para ver la tabla
        }

        function abrirModalStock(id, nombre) {
            document.getElementById('modal-id').value = id;
            document.getElementById('modal-nom').innerText = nombre;
            new bootstrap.Modal(document.getElementById('modalStock')).show();
        }

        function cerrar() {
            document.getElementById('vista-danadas').style.display = 'none';
            document.getElementById('vista-alquiler').style.display = 'none';
        }

        // --- 3. Funciones de PDF (Las tuyas estaban bien) ---
        function descargarPDFIndividual() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('COMPROBANTE EVENT CLUB', 20, 20);
            doc.autoTable({
                startY: 30,
                body: [
                    ['Cliente', document.getElementById('cal-cliente').innerText],
                    ['Pedido', document.getElementById('cal-articulo').innerText],
                    ['Ubicaci贸n', document.getElementById('cal-ubi').innerText],
                    ['Estado', document.getElementById('cal-estado').innerText]
                ]
            });
            doc.save('Comprobante.pdf');
        }

        function descargarReporteDiario(fecha, eventos) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l');
            const filas = eventos.map(e => [e.extendedProps.cliente, e.extendedProps.articulo, e.extendedProps.ubicacion, e.extendedProps.estado]);
            doc.text(`REPORTE ${fecha}`, 14, 15);
            doc.autoTable({ head: [['Cliente', 'Pedido', 'Ubicaci贸n', 'Estado']], body: filas, startY: 20 });
            doc.save(`Reporte_${fecha}.pdf`);
        }
    </script>
</body>
</html>